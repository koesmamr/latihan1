<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daftar Hadir Rapat Koordinasi</title>
    <!-- Memuat Tailwind CSS untuk styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat library Signature Pad -->
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <style>
        /* Style tambahan untuk canvas tanda tangan */
        .signature-canvas {
            border: 2px dashed #cbd5e1;
            border-radius: 0.5rem;
            width: 100%;
            height: 200px;
            cursor: crosshair;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4 font-sans">
    
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
        
        <!-- Judul Utama -->
        <div class="text-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800">
                Daftar Hadir Rapat Koordinasi
            </h1>
            <h2 class="text-xl text-gray-600">Sewa Kantor</h2>
        </div>

        <!-- Formulir Daftar Hadir -->
        <form id="attendance-form" class="space-y-4">
            
            <!-- Input Nama -->
            <div>
                <label for="nama" class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap</label>
                <input type="text" id="nama" name="nama" required
                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            </div>

            <!-- Input Unit -->
            <div>
                <label for="unit" class="block text-sm font-medium text-gray-700 mb-1">Unit / Instansi</label>
                <input type="text" id="unit" name="unit" required
                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            </div>

            <!-- Area Tanda Tangan -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Tanda Tangan</label>
                <canvas id="signature-pad" class="signature-canvas"></canvas>
                <div class="text-right mt-2">
                    <button type="button" id="clear-signature" 
                            class="text-sm text-gray-600 hover:text-red-500">
                        Bersihkan Tanda Tangan
                    </button>
                </div>
            </div>

            <!-- Tombol Submit -->
            <div class="pt-2">
                <button type="submit" id="submit-button" 
                        class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-md shadow-lg
                               hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50
                               disabled:bg-gray-400 disabled:cursor-not-allowed">
                    Kirim Kehadiran
                </button>
            </div>
        </form>

        <!-- Pesan Status (Success/Error) -->
        <div id="message-container" class="mt-4 text-center">
            <div id="success-message" class="hidden p-3 rounded-md bg-green-100 text-green-800">
                Kehadiran Anda berhasil dicatat. Terima kasih!
            </div>
            <div id="error-message" class="hidden p-3 rounded-md bg-red-100 text-red-800">
                Gagal mengirim. Silakan coba lagi.
            </div>
            <div id="validation-message" class="hidden p-3 rounded-md bg-yellow-100 text-yellow-800">
                <!-- Pesan validasi akan diisi oleh JS -->
            </div>
        </div>

    </div>

    <script>
        // --- KONFIGURASI PENTING ---
        // GANTI URL INI dengan URL Web App dari Google Apps Script Anda setelah di-deploy.
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycby-RwcrHL9GfThavj5CQ8jVJU4rXMbASPO2LMCmZjn03Toq9_CA4-Z7lYx8_JU-zdkz/exec";
        // -------------------------

        // Inisialisasi Elemen DOM
        const canvas = document.getElementById("signature-pad");
        const signaturePad = new SignaturePad(canvas, {
            backgroundColor: 'rgb(255, 255, 255)'
        });
        
        const form = document.getElementById("attendance-form");
        const clearButton = document.getElementById("clear-signature");
        const submitButton = document.getElementById("submit-button");
        
        const successMessage = document.getElementById("success-message");
        const errorMessage = document.getElementById("error-message");
        const validationMessage = document.getElementById("validation-message");

        // Fungsi untuk menyesuaikan ukuran canvas saat layar diubah
        function resizeCanvas() {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
            signaturePad.clear(); // Hapus tanda tangan saat resize
        }
        
        window.addEventListener("resize", resizeCanvas);
        resizeCanvas();

        // Fungsi untuk menyembunyikan semua pesan
        function hideMessages() {
            successMessage.classList.add("hidden");
            errorMessage.classList.add("hidden");
            validationMessage.classList.add("hidden");
        }

        // Fungsi untuk menampilkan pesan validasi
        function showValidation(message) {
            hideMessages();
            validationMessage.textContent = message;
            validationMessage.classList.remove("hidden");
        }

        // Event listener untuk tombol "Bersihkan"
        clearButton.addEventListener("click", () => {
            signaturePad.clear();
            hideMessages();
        });

        // Event listener untuk "Submit" formulir
        form.addEventListener("submit", (event) => {
            event.preventDefault(); // Mencegah form submit default
            hideMessages();

            // Ambil nilai dari form
            const nama = document.getElementById("nama").value.trim();
            const unit = document.getElementById("unit").value.trim();

            // Validasi input
            if (!nama || !unit) {
                showValidation("Nama dan Unit wajib diisi.");
                return;
            }
            if (signaturePad.isEmpty()) {
                showValidation("Tanda tangan wajib diisi.");
                return;
            }
            
            if (GAS_WEB_APP_URL === "URL_WEB_APP_ANDA_DISINI") {
                showValidation("Konfigurasi error: URL Google Apps Script belum diatur.");
                return;
            }

            // Nonaktifkan tombol submit saat proses
            submitButton.disabled = true;
            submitButton.textContent = "Mengirim...";

            // Ubah tanda tangan menjadi format data URL (Base64)
            const ttd_base64 = signaturePad.toDataURL("image/png");

            // Kirim data ke Google Apps Script
            fetch(GAS_WEB_APP_URL, {
                method: "POST",
                mode: "cors", // Mode CORS diperlukan
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    nama: nama,
                    unit: unit,
                    ttd_base64: ttd_base64,
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    // Jika sukses
                    successMessage.classList.remove("hidden");
                    form.reset();
                    signaturePad.clear();
                } else {
                    // Jika ada error dari server
                    errorMessage.textContent = data.message || "Terjadi kesalahan di server.";
                    errorMessage.classList.remove("hidden");
                }
            })
            .catch(error => {
                // Jika ada error jaringan (seringkali error CORS atau error di sisi Google Apps Script)
                console.error("Error:", error);
                
                let errorText = "Terjadi error jaringan. Silakan coba lagi.";
                if (error.message.includes("Failed to fetch")) {
                    // Berikan pesan yang lebih spesifik untuk error "Failed to fetch"
                    errorText = "Error: 'Failed to fetch'. Ini BUKAN error HTML. Ini biasanya berarti script Google Apps Anda (Kode.gs) gagal (crash) atau belum di-deploy dengan benar (pastikan 'Who has access' adalah 'Anyone'). Cek log 'Executions' di Google Apps Script Anda untuk melihat error yang sebenarnya.";
                } else {
                    errorText = "Error jaringan: " + error.message;
                }
                
                errorMessage.textContent = errorText;
                errorMessage.classList.remove("hidden");
            })
            .finally(() => {
                // Aktifkan kembali tombol submit
                submitButton.disabled = false;
                submitButton.textContent = "Kirim Kehadiran";
            });
        });
    </script>
</body>
</html>

